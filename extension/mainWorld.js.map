{
  "version": 3,
  "sources": ["../src/mainWorld.ts"],
  "sourcesContent": ["// ARQUIVO: src/mainWorld.ts\r\n\r\n/**\r\n * SignGuard - Main World Script (Interce\u00E7\u00E3o Agressiva)\r\n * Injetado via manifest.json com world: \"MAIN\"\r\n */\r\n\r\n// Mark ready for content script handshake\r\ntry {\r\n  document.documentElement.dataset.sgMainworld = \"1\";\r\n  window.postMessage({ source: \"signguard-inpage\", type: \"SG_MAINWORLD_READY\", version: \"1.0.0\" }, \"*\");\r\n} catch {}\r\n\r\nconst LOG_PREFIX = \"[SignGuard \uD83D\uDEE1\uFE0F]\";\r\nconst DEBUG = true; // Altere para false em produ\u00E7\u00E3o se desejar menos logs\r\n\r\nfunction log(...args: any[]) {\r\n  if (DEBUG) console.log(LOG_PREFIX, ...args);\r\n}\r\n\r\nfunction err(...args: any[]) {\r\n  console.error(LOG_PREFIX, ...args);\r\n}\r\n\r\n// Interfaces b\u00E1sicas para evitar erros de TS\r\ninterface RequestArguments {\r\n  method: string;\r\n  params?: unknown[] | object;\r\n}\r\n\r\ninterface EIP6963ProviderDetail {\r\n  info: {\r\n    uuid: string;\r\n    name: string;\r\n    icon: string;\r\n    rdns: string;\r\n  };\r\n  provider: any;\r\n}\r\n\r\n// --- CORE: L\u00F3gica de Interce\u00E7\u00E3o ---\r\n\r\n/**\r\n * Aplica o patch no m\u00E9todo .request do provider\r\n */\r\nfunction patchProvider(provider: any, walletName: string = \"Unknown\") {\r\n  if (!provider || provider._sg_patched) return; // J\u00E1 patcheado\r\n\r\n  log(`Patching provider: ${walletName}`);\r\n\r\n  // Tenta manter a refer\u00EAncia original\r\n  const originalRequest = provider.request.bind(provider);\r\n\r\n  // Sobrescreve o m\u00E9todo .request\r\n  try {\r\n    Object.defineProperty(provider, \"request\", {\r\n      value: async function (args: RequestArguments) {\r\n        // Filtra apenas m\u00E9todos cr\u00EDticos\r\n        const method = args.method;\r\n        const isCritical =\r\n          method === \"eth_sendTransaction\" ||\r\n          method === \"eth_signTypedData_v4\" ||\r\n          method === \"eth_signTypedData_v3\" ||\r\n          method === \"eth_sign\" ||\r\n          method === \"personal_sign\" ||\r\n          method === \"wallet_switchEthereumChain\" ||\r\n          method === \"wallet_addEthereumChain\";\r\n\r\n        if (!isCritical) {\r\n          return originalRequest(args);\r\n        }\r\n\r\n        log(`Intercepted Call: ${method}`, args);\r\n\r\n        // Gera ID \u00FAnico para rastreio\r\n        const requestId = crypto.randomUUID();\r\n\r\n        // Envia para o Content Script (Isolado)\r\n        // Usa \"*\" para evitar erros de 'target origin mismatch' em iframes\r\n        window.postMessage(\r\n          {\r\n            source: \"signguard\",\r\n            type: \"SG_REQUEST\",\r\n            requestId,\r\n            payload: {\r\n              method,\r\n              params: (args as any).params,\r\n              host: window.location.hostname,\r\n              url: window.location.href,\r\n              wallet: { name: walletName },\r\n            },\r\n          },\r\n          \"*\"\r\n        );\r\n\r\n        // Retorna uma Promise que espera a decis\u00E3o do utilizador\r\n        return new Promise((resolve, reject) => {\r\n          const handler = (ev: MessageEvent) => {\r\n            if (\r\n              ev.source === window &&\r\n              ev.data?.source === \"signguard-content\" &&\r\n              ev.data?.type === \"SG_DECISION\" &&\r\n              ev.data?.requestId === requestId\r\n            ) {\r\n              window.removeEventListener(\"message\", handler);\r\n\r\n              const { allow, errorMessage } = ev.data;\r\n              log(`Decision received for ${requestId}: ${allow ? \"ALLOW\" : \"BLOCK\"}`);\r\n\r\n              if (allow) {\r\n                // Se permitido, chama o original\r\n                originalRequest(args)\r\n                  .then(resolve)\r\n                  .catch(reject);\r\n              } else {\r\n                // Se bloqueado, rejeita a transa\u00E7\u00E3o (simula rejei\u00E7\u00E3o do utilizador)\r\n                reject({\r\n                  code: 4001,\r\n                  message: errorMessage || \"SignGuard: Transaction blocked by user security settings.\",\r\n                });\r\n              }\r\n            }\r\n          };\r\n\r\n          window.addEventListener(\"message\", handler);\r\n        });\r\n      },\r\n      configurable: true,\r\n      writable: true,\r\n    });\r\n\r\n    // Marca como patcheado para n\u00E3o repetir\r\n    provider._sg_patched = true;\r\n  } catch (e) {\r\n    err(\"Failed to overwrite provider.request\", e);\r\n  }\r\n}\r\n\r\n// --- INIT: Estrat\u00E9gias de Captura ---\r\n\r\nfunction init() {\r\n  log(\"Initializing interception...\");\r\n\r\n  // 1. Captura Imediata (se j\u00E1 existir)\r\n  if ((window as any).ethereum) {\r\n    patchProvider((window as any).ethereum, \"window.ethereum\");\r\n  }\r\n\r\n  // 2. Hook no Object.defineProperty (Para capturar quando o MetaMask injetar)\r\n  let storedEthereum = (window as any).ethereum;\r\n  try {\r\n    Object.defineProperty(window, \"ethereum\", {\r\n      get() {\r\n        return storedEthereum;\r\n      },\r\n      set(val) {\r\n        storedEthereum = val;\r\n        patchProvider(val, \"window.ethereum (Setter)\");\r\n      },\r\n      configurable: true, // Permite que o MetaMask sobrescreva, mas n\u00F3s j\u00E1 peg\u00E1mos a refer\u00EAncia no Setter\r\n    });\r\n  } catch (e) {\r\n    // Se falhar (ex: j\u00E1 definido como n\u00E3o-configur\u00E1vel), fallback para polling\r\n    log(\"Hook defineProperty failed, relying on polling.\");\r\n  }\r\n\r\n  // 3. EIP-6963 (Multi-Wallet Discovery) - O standard moderno\r\n  window.addEventListener(\"eip6963:announceProvider\", (event: any) => {\r\n    const detail = event.detail as EIP6963ProviderDetail;\r\n    if (detail && detail.provider) {\r\n      patchProvider(detail.provider, detail.info.name || \"EIP-6963 Wallet\");\r\n    }\r\n  });\r\n  // Dispara pedido para as carteiras se anunciarem\r\n  window.dispatchEvent(new Event(\"eip6963:requestProvider\"));\r\n\r\n  // 4. Polling de Seguran\u00E7a (Sledgehammer)\r\n  // Verifica a cada 100ms se surgiu um novo provider n\u00E3o patcheado\r\n  // (Resolve casos onde o MetaMask sobrescreve o objeto window.ethereum completamente)\r\n  const interval = setInterval(() => {\r\n    const eth = (window as any).ethereum;\r\n    if (eth && !eth._sg_patched) {\r\n      patchProvider(eth, \"Polling Detected\");\r\n    }\r\n  }, 100);\r\n\r\n  // Para o polling ap\u00F3s 5 segundos (a maioria das inje\u00E7\u00F5es ocorre no in\u00EDcio)\r\n  setTimeout(() => clearInterval(interval), 5000);\r\n}\r\n\r\n// Inicia imediatamente\r\ninit();\r\n"],
  "mappings": "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",
  "names": []
}
